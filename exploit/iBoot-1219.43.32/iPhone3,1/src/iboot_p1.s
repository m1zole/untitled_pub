@ iboot_p1.s
@
@ Copyright (c) 2021 @dora2ios
@
@


    .text
    .syntax    unified


    .arm
_entry:
    b    _entry

    .org    0x778
    .arm
_disable_interrupts:
    bx    lr

    .org    0x1ae7c
    .thumb_func
_arch_cpu_quiesce:
    bx    lr

    .org    0x2e868
    .arm
_bcopy:
    bx    lr


    .org    0x3da3c
    .global _payload
    .thumb
    .thumb_func
_payload:
    ldr    sp, =0x5FFF8000
    blx    _disable_interrupts
    ldr    r4, =0x44000000

    ldr    r0, =0x5ff00000          @ could be 0, but we use explicit offset for iloader
    mov    r1, r4
    ldr    r2, =0x3acc0
    blx    _bcopy

    ldr    r0, =0x14ff4
    ldr    r1, =0x60182000
    str    r1, [r4, r0]             @ accept unsigned images

    ldr    r0, =0xbe0
    ldr    r1, =0x5ff391a1          @ payload start + 1
    str    r1, [r4, r0]             @ change ptr of main_task() to payload.

    ldr    r0, =0x5ff3dd3c
    ldr    r1, =0x440391a0          @ payload start
    movs   r2, #0x44                @ payload_size
    blx    _bcopy

    ldr    r0, =0x5ff3db3c          @ nettoyeur [ARM]
    mov    r5, r0

    bl     _arch_cpu_quiesce
    blx    r5                       @ nettoyeur()
    bx     r4

.align    2
