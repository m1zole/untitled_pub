@ payload.s
@
@ Copyright (c) 2021 - 2023 @ kok3shidoll
@
@


.set    JUMP_ADDRESS_PTR,   0xbff43fa0  @ end point of payload
.set    IMAGE3_TYPE,        0x69626f62  @ 'ibob' : new iBoot TYPE
.set    IMAGE3_SEC_TYPE,    0x69626f63  @ 'iboc' : new iBoot TYPE


    .text
    .syntax unified

    .arm
_entry:
    b   _entry


    .org    0x844
    .thumb
    .thumb_func
_find_boot_images:
    bx    lr


    .org    0x1f674
    .thumb
    .thumb_func
_platform_init:
    bx    lr


    .org    0x20a74
    .thumb
    .thumb_func
_prepare_and_jump:
    bx    lr


    .org    0x25e60
    .thumb
    .thumb_func
_image_load_type:
    bx    lr


    .org    0x35548
    .thumb
    .thumb_func
_disable_interrupts:
    bx    lr


    .org    0x43f40
    .global _payload
    .thumb
    .thumb_func
_payload:
_payload$check_button:
    movs       r1, #0x10                @ mutebutton offset
    movt       r1, #0x3fa0              @ gpioBase
    ldr        r0, [r1]
    tst.w      r0, #0x1
    beq.n      _payload$secondos

_payload$main:
    ldr        sp, =0xbfff8000
    bl         _disable_interrupts

    bl         _platform_init
    bl         _find_boot_images

    ldr        r0, =JUMP_ADDRESS_PTR
    adds       r1, r0, #0x4
    mov.w      r2, #0x84000000
    str        r2, [r0]
    mov.w      r2, #0x100000
    str        r2, [r1]
    ldr        r2, =IMAGE3_TYPE
    bl         _image_load_type         @ _image_load_type(*ptr, *sz, type)

    b          _payload$jump_to

_payload$secondos:
    ldr        r0, =JUMP_ADDRESS_PTR
    adds       r1, r0, #0x4
    mov.w      r2, #0x84000000
    str        r2, [r0]
    mov.w      r2, #0x100000
    str        r2, [r1]
    ldr        r2, =IMAGE3_SEC_TYPE
    bl         _image_load_type         @ _image_load_type(*ptr, *sz, type)
    b          _payload$jump_to


_payload$jump_to:
    movs       r0, #0x2                 @ BOOT_IBOOT
    ldr        r1, =0x84000000          @ ptr
    movs       r2, #0x0                 @ args
    movs       r3, #0x0
    bl         _prepare_and_jump        @ _prepare_and_jump(BOOT_IBOOT, jumpaddr, 0, 0)

    nop
